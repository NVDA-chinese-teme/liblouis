#!/usr/bin/make -f

BASE_TABLE         = sbs.dis,sbs-de-core6.cti,sbs-apos.cti,sbs-de-accents.cti
PATTERNS_TABLE     = sbs-patterns.dic
CONTRACTIONS_TABLE = sbs-contractions.ctb
DICTIONARY         = sbs-dictionary.sqlite
WORKING_FILE       = working_file.txt

LEFT_HYPHEN_MIN    = 1
RIGHT_HYPHEN_MIN   = 1
HYPH_LEVEL         = 1
PAT_START          = 1
PAT_FINISH         = 15
GOOD_WEIGHT        = 1
BAD_WEIGHT         = 100
THRESHOLD          = 1

all : tables

.PHONY : all suggestions patterns tables dictionary

patterns : $(PATTERNS_TABLE)
tables : $(CONTRACTIONS_TABLE) $(PATTERNS_TABLE)
dictionary : $(DICTIONARY)

suggestions : $(CONTRACTIONS_TABLE) $(PATTERNS_TABLE)

suggestions :
	bash wrap_python.sh make_suggestions.py -d $(DICTIONARY) -t $(BASE_TABLE),$(CONTRACTIONS_TABLE),$(PATTERNS_TABLE) -x true >$(WORKING_FILE)
	$(EDITOR) $(WORKING_FILE)

.INTERMEDIATE : $(WORKING_FILE)

$(CONTRACTIONS_TABLE) : $(WORKING_FILE)
	bash submit_rules.sh $< $@ $(BASE_TABLE)

$(DICTIONARY) : $(WORKING_FILE)
	bash submit_rows.sh $< $@ $(BASE_TABLE)

$(PATTERNS_TABLE) : patterns.$(HYPH_LEVEL).dic check-patterns
	cp $< $@

.PHONY : check-patterns
check-patterns : dictionary.$(HYPH_LEVEL)
	# dictionary file must not contain bad (.) or missed (-) hyphens"
	if cat $< | grep '\.[^0]\|-' >/dev/null; then false; else true; fi

$(patsubst %,patterns.%.dic,1 2 3 4 5 6 7 8 9) : %.dic : %
	perl substrings.pl $< tmp
	@echo "UTF-8\n\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%\n\
% auto-generated file, don't edit! %\n\
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%" | cat - tmp >$@
	@rm tmp

-include make-patterns.mk
make-patterns.mk : make
	rm -f $@
	@for level in $(HYPH_LEVEL); do \
		echo "patterns.$$(($$level-1)) :" && \
		echo "	touch \$$@" && \
		echo "" && \
		echo "dictionary.$$(($$level-1)) : \$$(DICTIONARY)" && \
		echo "	bash wrap_python.sh export_chunked_words.py -d \$$< >\$$@" && \
		echo "" && \
		echo "patterns.$$level : dictionary.$$(($$level-1)) patterns.$$(($$level-1)) alphabet" && \
		echo "	bash wrap_patgen.sh \$$< \$$(word 2,\$$^) \$$@ \$$(word 3,\$$^) \\" && \
		echo "		\$$(LEFT_HYPHEN_MIN) \$$(RIGHT_HYPHEN_MIN) $$level \$$(PAT_START) \$$(PAT_FINISH) \$$(GOOD_WEIGHT) \$$(BAD_WEIGHT) \$$(THRESHOLD)" && \
		echo "" && \
		echo "dictionary.$$level : \$$(DICTIONARY) patterns.$$level.dic pattmp.$$level" && \
		echo "	bash wrap_python.sh export_chunked_words.py -d \$$< -t \$$(BASE_TABLE),\$$(word 2,\$$^) >\$$@" && \
		echo "	# dictionary file that we produced must be identical to the one that patgen produced" && \
		echo "	diff \$$@ \$$(word 3,\$$^) >/dev/null" && \
		echo ""; \
	done >$@

alphabet : $(DICTIONARY)
	bash wrap_python.sh generate_alphabet.py -d $< -t $(BASE_TABLE) >$@
